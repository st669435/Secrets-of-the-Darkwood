/* Проект «Секреты Тёмнолесья»
 * Цель проекта: изучить влияние характеристик игроков и их игровых персонажей 
 * на покупку внутриигровой валюты «райские лепестки», а также оценить 
 * активность игроков при совершении внутриигровых покупок
 * 
 * Автор: Клычкова Оксана
 * Дата: 29.12.2025
*/

-- Часть 1. Исследовательский анализ данных
-- Задача 1. Исследование доли платящих игроков 
-- 1.1. Доля платящих пользователей по всем данным:
count_users|users_pay|avg_payer|
-----------+---------+---------+
      22214|     3929|    17.69|

SELECT 
COUNT(*) AS count_users,-- общее количество игроков
SUM(payer) AS users_pay,-- количество платящих игроков
ROUND(AVG(payer) * 100, 2) AS avg_payer -- доля в процентах
FROM fantasy.users

-- 1.2. Доля платящих пользователей в разрезе расы персонажа:
SELECT race_id AS race,
COUNT(*) AS count_users,-- общее количество игроков
SUM(payer) AS users_pay,-- количество платящих игроков
ROUND(AVG(payer) * 100, 2) AS avg_payer -- доля в процентах
FROM fantasy.users
GROUP BY race_id
ORDER BY race_id;
race|count_users|users_pay|avg_payer|
----+-----------+---------+---------+
B1  |       2501|      427|    17.07|
C5  |       3562|      626|    17.57|
I6  |       1327|      229|    17.26|
K3  |       3619|      636|    17.57|
K4  |       3648|      659|    18.06|
R2  |       6328|     1114|    17.60|
T7  |       1229|      238|    19.37|

-- Задача 2. Исследование внутриигровых покупок
-- 2.1. Статистические показатели по полю amount:
SELECT 
COUNT(amount) AS count_amount,--общее количество покупок
SUM(amount) AS sum_amount,--суммарную стоимость всех покупок
MIN(amount) AS min_amount,
MAX(amount) AS max_amount , -- минимальная и максимальная стоимость покупки
AVG(amount) AS avg_amount, -- среднее значение
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY amount) AS median_amount, -- медиана
STDDEV(amount) AS stddev_amount -- стандартное отклонение стоимости покупки
FROM fantasy.events

count_amount|sum_amount|min_amount|max_amount|avg_amount       |median_amount    |stddev_amount    |
------------+----------+----------+----------+-----------------+-----------------+-----------------+
     1307678| 686615040|       0.0|  486615.1|525.6919663589833|74.86000061035156|2517.345444427788|

-- 2.2: Аномальные нулевые покупки:
SELECT 
COUNT(*) AS total_events,
SUM(CASE WHEN amount = 0 THEN 1 ELSE 0 END) AS zero_amount,
SUM(CASE WHEN amount = 0 THEN 1 ELSE 0 END)::numeric / COUNT(*) * 100 AS part_zero_amount
FROM fantasy.events

total_events|zero_amount|part_zero_amount      |
------------+-----------+----------------------+
     1307678|        907|0.06935958240484278200|

-- 2.3: Популярные эпические предметы:
WITH filter_zero AS (
    -- Фильтрация покупок с нулевой стоимостью
SELECT *
FROM fantasy.events
WHERE amount > 0
),
epic_item_stats AS (
SELECT
i.game_items AS item_name,
COUNT(*) AS absolute_sales_count,
COUNT(DISTINCT fs.id) AS unique_buyers_count
FROM filter_zero AS fs
JOIN fantasy.items AS i ON fs.item_code = i.item_code
GROUP BY i.game_items
)
SELECT item_name, absolute_sales_count,
absolute_sales_count * 1.0 / (SELECT COUNT(*) FROM filter_zero) AS relative_sales_share,
unique_buyers_count * 1.0 / (SELECT COUNT(DISTINCT id) FROM filter_zero) AS buyer_share
FROM epic_item_stats
ORDER BY buyer_share DESC;

item_name                |absolute_sales_count|relative_sales_share      |buyer_share               |
-------------------------+--------------------+--------------------------+--------------------------+
Book of Legends          |             1004516|    0.76870086648693611964|    0.88413573085846867749|
Bag of Holding           |              271875|    0.20805098980617108889|    0.86774941995359628770|
Necklace of Wisdom       |               13828|    0.01058180813623810140|    0.11796693735498839907|
Gems of Insight          |                3833|    0.00293318416157077254|    0.06714037122969837587|
Treasure Map             |                3183|    0.00243577489858590373|    0.05938225058004640371|
Silver Flask             |                 795|    0.00060836979088149339|    0.04589617169373549884|
Amulet of Protection     |                1078|    0.00082493413153490550|    0.03226508120649651972|
Glowing Pendant          |                 563|    0.00043083294624689406|    0.02566705336426914153|
Strength Elixir          |                 580|    0.00044384211158649832|    0.02399941995359628770|
Ring of Wisdom           |                 379|    0.00029002786257117735|    0.02247679814385150812|
Gauntlets of Might       |                 514|    0.00039333594026803472|    0.02037412993039443155|
Potion of Speed          |                 375|    0.00028696688249127047|    0.01674883990719257541|
Ring of Invisibility     |                 252|    0.00019284174503413375|    0.01334106728538283063|
Potion of Acceleration   |                 230|    0.00017600635459464589|    0.01305104408352668213|
Feather of Writing       |                 222|    0.00016988439443483212|    0.01116589327146171694|
Time Artifact            |                 168|    0.00012856116335608917|    0.01073085846867749420|
Herbs for Potions        |                 241|    0.00018442404981438982|    0.01073085846867749420|
Monster Compendium       |                 151|    0.00011555199801648491|    0.01000580046403712297|
Water of Life            |                 142|    0.00010866479283669442|    0.00884570765661252900|
Trap Chest               |                 137|    0.00010483856773681081|    0.00870069605568445476|
Scroll of Magic          |                 162|    0.00012396969323622884|    0.00848317865429234339|
Magic Ornament           |                 282|    0.00021579909563343539|    0.00819315545243619490|
Magical Lantern          |                 247|    0.00018901551993425015|    0.00739559164733178654|
Enemy Traps              |                 168|    0.00012856116335608917|    0.00681554524361948956|
Magic Key                |                 127|0.000097186117537043598305|    0.00587296983758700696|
Robe of the Magi         |                  85|0.000065045826698021305952|    0.00580046403712296984|
Dungeon Map              |                 108|0.000082646462157485894621|    0.00536542923433874710|
Runes of Power           |                 106|0.000081115972117532452128|    0.00529292343387470998|
Magic Dust               |                  82|0.000062750091638091142212|    0.00522041763341067285|
Druid's Staff            |                  83|0.000063515336658067863459|    0.00442285382830626450|
Sea Serpent Scale        |                 458|    0.00035048221914933833|    0.00427784222737819026|
Boots of Levitation      |                  73|0.000055862886458300650994|    0.00398781902552204176|
Chimera Scale            |                  67|0.000051271416338440323515|    0.00398781902552204176|
Mystic Compass           |                  83|0.000063515336658067863459|    0.00391531322505800464|
Potion of Intelligence   |                  50|0.000038262250998836062325|    0.00340777262180974478|
Antidote Potion          |                  89|0.000068106806777928190938|    0.00340777262180974478|
Treasure Box             |                  79|0.000060454356578160978473|    0.00333526682134570766|
Enhanced Weapon          |                  60|0.000045914701198603274790|    0.00297273781902552204|
Orb of Time              |                  56|0.000042853721118696389804|    0.00282772621809744780|
Elf Ears                 |                  44|0.000033670780878975734846|    0.00282772621809744780|
Scroll of Summoning      |                  49|0.000037497005978859341078|    0.00268271461716937355|
Orc Tusk                 |                  45|0.000034436025898952456092|    0.00253770301624129930|
Helm of Insight          |                  57|0.000043618966138673111050|    0.00232018561484918794|
Shield of Valor          |                  38|0.000029079310759115407367|    0.00203016241299303944|
Potion of Fortitude      |                  31|0.000023722595619278358641|    0.00203016241299303944|
Pegasus Feather          |                 138|    0.00010560381275678753|    0.00188515081206496520|
Succubus Kiss            |                  35|0.000026783575699185243627|    0.00181264501160092807|
Transformation Potion    |                  26|0.000019896370519394752409|    0.00174013921113689095|
Boots of Swiftness       |                  29|0.000022192105579324916148|    0.00174013921113689095|
Pendant of Healing       |                  25|0.000019131125499418031162|    0.00159512761020881671|
Potion of Transformation |                  28|0.000021426860559348194902|    0.00159512761020881671|
Scroll of Resurrection   |                  27|0.000020661615539371473655|    0.00152262180974477958|
Armor of Magic Resistance|                  21|0.000016070145419511146176|    0.00152262180974477958|
Medallion of Magic       |                  24|0.000018365880479441309916|    0.00137761020881670534|
Phoenix Feather          |                  56|0.000042853721118696389804|    0.00137761020881670534|
Quiver of Endless Arrows |                  45|0.000034436025898952456092|    0.00137761020881670534|
Enchanter's Amulet       |                  19|0.000014539655379557703683|    0.00137761020881670534|
Mirror of Divination     |                  21|0.000016070145419511146176|    0.00137761020881670534|
Crown of Kings           |                  18|0.000013774410359580982437|    0.00130510440835266821|
Nature's Strength Potion |                  20|0.000015304900399534424930|    0.00130510440835266821|
Potion of Regeneration   |                  20|0.000015304900399534424930|    0.00123259860788863109|
Fire Resistance Potion   |                  22|0.000016835390439487867423|    0.00108758700696055684|
Cloak of Shadows         |                  15|0.000011478675299650818697|    0.00108758700696055684|
Shield of Protection     |                  14|0.000010713430279674097451|    0.00101508120649651972|
Fairy Dust               |                  21|0.000016070145419511146176|    0.00094257540603248260|
Kraken Ink               |                  13|0.000009948185259697376204|    0.00079756380510440835|
Potion of Light          |                  13|0.000009948185259697376204|    0.00079756380510440835|
Stone of Power           |                  12|0.000009182940239720654958|    0.00079756380510440835|
Dragon Cart              |                  15|0.000011478675299650818697|    0.00079756380510440835|
Magic Animal             |                  11|0.000008417695219743933711|    0.00072505800464037123|
Invisibility Potion      |                  12|0.000009182940239720654958|    0.00072505800464037123|
Hydra Tooth              |                  10|0.000007652450199767212465|    0.00065255220417633411|
Staff of Flames          |                   9|0.000006887205179790491218|    0.00058004640371229698|
Potion of Wisdom         |                   9|0.000006887205179790491218|    0.00058004640371229698|
Vampire Fang             |                  10|0.000007652450199767212465|    0.00058004640371229698|
Potion of Darkness       |                   8|0.000006121960159813769972|    0.00050754060324825986|
Defender's Guard         |                  10|0.000007652450199767212465|    0.00050754060324825986|
Ethereal Horse           |                   7|0.000005356715139837048725|    0.00043503480278422274|
Amulet of Time           |                   6|0.000004591470119860327479|    0.00043503480278422274|
Traveler's Supplies      |                  10|0.000007652450199767212465|    0.00043503480278422274|
Protective Cloak         |                   9|0.000006887205179790491218|    0.00043503480278422274|
Wyvern Claw              |                  11|0.000008417695219743933711|    0.00043503480278422274|
Luminescent Gem          |                   6|0.000004591470119860327479|    0.00036252900232018561|
Mystic Bracelets         |                   6|0.000004591470119860327479|    0.00036252900232018561|
Silver Talons            |                   5|0.000003826225099883606232|    0.00036252900232018561|
Sorcerer's Stone         |                   5|0.000003826225099883606232|    0.00036252900232018561|
Book of Spells           |                   6|0.000004591470119860327479|    0.00036252900232018561|
Book of Curses           |                   6|0.000004591470119860327479|    0.00036252900232018561|
Griffin Feather          |                   6|0.000004591470119860327479|    0.00029002320185614849|
Healer's Kit             |                   4|0.000003060980079906884986|    0.00029002320185614849|
Gold Coins               |                   4|0.000003060980079906884986|    0.00029002320185614849|
Magic Orb                |                   4|0.000003060980079906884986|    0.00029002320185614849|
Potion of Clarity        |                   5|0.000003826225099883606232|    0.00029002320185614849|
Prophet's Scroll         |                   4|0.000003060980079906884986|    0.00029002320185614849|
Shovel of Secrets        |                   5|0.000003826225099883606232|    0.00029002320185614849|
Ancient Artifact         |                   8|0.000006121960159813769972|    0.00029002320185614849|
Unicorn Horn             |                   8|0.000006121960159813769972|    0.00029002320185614849|
Wand of Lightning        |                   4|0.000003060980079906884986|    0.00029002320185614849|
Weapon Decoration        |                   5|0.000003826225099883606232|    0.00029002320185614849|
Weapon Oil               |                   7|0.000005356715139837048725|    0.00029002320185614849|
Crystal of Wisdom        |                   4|0.000003060980079906884986|    0.00021751740139211137|
Diviner's Tarot Deck     |                   4|0.000003060980079906884986|    0.00021751740139211137|
Ring of Regeneration     |                   3|0.000002295735059930163739|    0.00021751740139211137|
Flask of Endless Water   |                   3|0.000002295735059930163739|    0.00021751740139211137|
Boots of Haste           |                   3|0.000002295735059930163739|    0.00021751740139211137|
Ring of Strength         |                   4|0.000003060980079906884986|    0.00021751740139211137|
Protection Potion        |                   2|0.000001530490039953442493|    0.00014501160092807425|
Quill of Enchantment     |                   3|0.000002295735059930163739|    0.00014501160092807425|
Necromancer's Wand       |                   2|0.000001530490039953442493|    0.00014501160092807425|
Cloak of Invisibility    |                   2|0.000001530490039953442493|    0.00014501160092807425|
Cleansing Potion         |                   3|0.000002295735059930163739|    0.00014501160092807425|
Mystic's Rune Stones     |                   2|0.000001530490039953442493|    0.00014501160092807425|
Warlock's Grimoire       |                   2|0.000001530490039953442493|    0.00014501160092807425|
Medusa's Snake           |                   2|0.000001530490039953442493|    0.00014501160092807425|
Book of Rituals          |                   2|0.000001530490039953442493|    0.00014501160092807425|
Talisman of Luck         |                   4|0.000003060980079906884986|    0.00014501160092807425|
Manticore Tail           |                   2|0.000001530490039953442493|    0.00014501160092807425|
Magic Sand               |                   5|0.000003826225099883606232|    0.00014501160092807425|
Bandages of Recovery     |                   2|0.000001530490039953442493|    0.00014501160092807425|
Knight's Shield          |                   2|0.000001530490039953442493|    0.00014501160092807425|
Paladin's Hammer         |                   2|0.000001530490039953442493|    0.00014501160092807425|
Mermaid's Tear           |                   1|0.000000765245019976721246|0.000072505800464037122970|
Gloves of Strength       |                   1|0.000000765245019976721246|0.000072505800464037122970|
Stone of Teleportation   |                   1|0.000000765245019976721246|0.000072505800464037122970|
Map of Realms            |                   1|0.000000765245019976721246|0.000072505800464037122970|
Potion of Power          |                   1|0.000000765245019976721246|0.000072505800464037122970|
Sword of Flames          |                   1|0.000000765245019976721246|0.000072505800464037122970|
Sword of Ice             |                   1|0.000000765245019976721246|0.000072505800464037122970|
Elixir of Mana           |                   1|0.000000765245019976721246|0.000072505800464037122970|
Demon's Horn             |                   1|0.000000765245019976721246|0.000072505800464037122970|
Compass of Truth         |                   3|0.000002295735059930163739|0.000072505800464037122970|
Dragon Scale             |                   1|0.000000765245019976721246|0.000072505800464037122970|
Scroll of Fireball       |                   1|0.000000765245019976721246|0.000072505800464037122970|
Magic Carpet             |                   1|0.000000765245019976721246|0.000072505800464037122970|
Incubus Whisper          |                   1|0.000000765245019976721246|0.000072505800464037122970|
Bow of Magic             |                   1|0.000000765245019976721246|0.000072505800464037122970|
Elixir of Night Vision   |                   1|0.000000765245019976721246|0.000072505800464037122970|
Mystic Armor             |                   1|0.000000765245019976721246|0.000072505800464037122970|
Boots of Silence         |                   1|0.000000765245019976721246|0.000072505800464037122970|
Werewolf Fur             |                   1|0.000000765245019976721246|0.000072505800464037122970|
Bow of Precision         |                   1|0.000000765245019976721246|0.000072505800464037122970|
Monk's Prayer Beads      |                   1|0.000000765245019976721246|0.000072505800464037122970|
Minotaur Horn            |                   1|0.000000765245019976721246|0.000072505800464037122970|
Spectral Shield          |                   1|0.000000765245019976721246|0.000072505800464037122970|

-- Часть 2. Решение ad hoc-задачи
-- Задача: Зависимость активности игроков от расы персонажа:
-- Общее количество зарегистрированных игроков по расам
WITH registered_players AS (
SELECT race_id,
COUNT(*) as total_registered
FROM fantasy.users
GROUP BY race_id
),
--  количество игроков, которые совершают внутриигровые покупки, и их доля от общего количества зарегистрированных игроков
paying_players AS (
    SELECT 
u.race_id,
COUNT(DISTINCT e.id) as total_paying,
COUNT(DISTINCT e.id)::numeric / COUNT(*) as paying_ratio
FROM fantasy.users u
LEFT JOIN fantasy.events e ON u.id = e.id  AND e.amount > 0  -- Исключаем покупки с нулевой стоимостью
GROUP BY u.race_id
),
--доля платящих игроков среди игроков, которые совершили внутриигровые покупки
player_activity AS (
SELECT u.race_id, e.id,
COUNT(e.id) as purchase_count,
SUM(e.amount) as total_spent,
AVG(e.amount) as avg_purchase_value
FROM fantasy.users AS u
INNER JOIN fantasy.events AS e ON u.id = e.id 
AND e.amount > 0 
GROUP BY u.race_id, e.id
),
-- 1)среднее количество покупок на одного игрока, совершившего внутриигровые покупки 2)средняя стоимость одной покупки на одного игрока, совершившего внутриигровые покупки; 3)средняя суммарная стоимость всех покупок на одного игрока, совершившего внутриигровые покупки.
activity_summary AS (
SELECT race_id,
COUNT(DISTINCT id) as active_paying_players,
AVG(purchase_count) as avg_purchases_per_payer,
AVG(total_spent) as avg_total_spent_per_payer,
AVG(avg_purchase_value) as avg_purchase_value_per_payer
FROM player_activity
GROUP BY race_id
)
SELECT rp.race_id, rp.total_registered,
pp.total_paying as total_paying_players,
-- Доля платящих от общего количества зарегистрированных
pp.paying_ratio  AS paying_ratio_percent,
    -- Доля платящих среди тех, кто вообще покупал
asum.active_paying_players::numeric / pp.total_paying * 100 AS paying_among_buyers_percent,
    -- Среднее количество покупок на одного платящего игрока
asum.avg_purchases_per_payer AS avg_purchases_per_paying_player,
    -- Средняя стоимость одной покупки
asum.avg_purchase_value_per_payer AS avg_purchase_value,
    -- Средняя суммарная стоимость всех покупок на одного платящего игрока
asum.avg_total_spent_per_payer AS avg_total_spent_per_paying_player
FROM registered_players AS rp
LEFT JOIN paying_players AS pp ON rp.race_id = pp.race_id
LEFT JOIN activity_summary AS asum ON rp.race_id = asum.race_id
ORDER BY rp.race_id;

race_id|total_registered|total_paying_players|paying_ratio_percent  |paying_among_buyers_percent|avg_purchases_per_paying_player|avg_purchase_value|avg_total_spent_per_paying_player|
-------+----------------+--------------------+----------------------+---------------------------+-------------------------------+------------------+---------------------------------+
B1     |            2501|                1543|0.01259262886429667352|   100.00000000000000000000|            78.7906675307841866|  791.837779886691|                53761.65357472614|
C5     |            3562|                2229|0.01209191810695570094|   100.00000000000000000000|            82.1018393898609242| 781.0535969743916|               62520.659329105394|
I6     |            1327|                 820|0.00930897862340640503|   100.00000000000000000000|           106.8048780487804878| 775.5473887338326|               48668.653708467544|
K3     |            3619|                2276|0.01214650521136306630|   100.00000000000000000000|            81.7381370826010545| 709.4439156851955|                41760.04062863972|
K4     |            3648|                2266|0.01152887306029000254|   100.00000000000000000000|            86.1288614298323036| 699.8950859368514|                47620.92312036146|
R2     |            6328|                3921|0.00819564195014892616|   100.00000000000000000000|           121.4021933180311145| 733.6179968254801|                48941.00985064767|
T7     |            1229|                 737|0.01273280121626757887|   100.00000000000000000000|            77.8697421981004071| 735.4793590113007|               41197.379648772156|
